name: Deploy para VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente para deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      force_ssl_setup:
        description: 'ForÃ§ar reconfiguraÃ§Ã£o SSL'
        required: false
        default: false
        type: boolean
      version_tag:
        description: 'Tag de versÃ£o (deixe vazio para auto-gerar)'
        required: false
        type: string
      debug_ssh:
        description: 'Debug SSH (apenas para troubleshooting)'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # NecessÃ¡rio para tags
        
    - name: Verificar secrets obrigatÃ³rios
      run: |
        echo "ğŸ” Verificando configuraÃ§Ã£o de secrets..."
        
        # Lista de secrets obrigatÃ³rios
        MISSING_SECRETS=""
        
        if [ -z "${{ secrets.VPS_HOST }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS VPS_HOST"
        fi
        
        if [ -z "${{ secrets.VPS_USERNAME }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS VPS_USERNAME"
        fi
        
        # Verificar se tem pelo menos uma forma de autenticaÃ§Ã£o
        if [ -z "${{ secrets.VPS_PASSWORD }}" ] && [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS VPS_PASSWORD_ou_VPS_SSH_KEY"
        fi
        
        if [ -z "${{ secrets.DOMAIN_NAME }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS DOMAIN_NAME"
        fi
        
        if [ -z "${{ secrets.JWT_SECRET }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS JWT_SECRET"
        fi
        
        if [ -z "${{ secrets.ADMIN_USERNAME }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS ADMIN_USERNAME"
        fi
        
        if [ -z "${{ secrets.ADMIN_PASSWORD }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS ADMIN_PASSWORD"
        fi
        
        if [ -n "$MISSING_SECRETS" ]; then
          echo "âŒ ERRO: Secrets obrigatÃ³rios nÃ£o configurados:"
          for secret in $MISSING_SECRETS; do
            echo "  - $secret"
          done
          echo ""
          echo "ğŸ“ Configure estes secrets em: Settings â†’ Secrets and variables â†’ Actions"
          exit 1
        fi
        
        echo "âœ… Todos os secrets obrigatÃ³rios estÃ£o configurados"
        
        # Debug info (sem expor valores)
        echo "ğŸ”§ InformaÃ§Ãµes de configuraÃ§Ã£o:"
        echo "  - Host: ${{ secrets.VPS_HOST }}"
        echo "  - UsuÃ¡rio: ${{ secrets.VPS_USERNAME }}"
        echo "  - AutenticaÃ§Ã£o: $([ -n "${{ secrets.VPS_SSH_KEY }}" ] && echo "SSH Key" || echo "Password")"
        echo "  - DomÃ­nio: ${{ secrets.DOMAIN_NAME }}"
        
    - name: Configurar variÃ¡veis de ambiente
      id: vars
      run: |
        # Gerar versÃ£o baseada na data e commit
        if [ -n "${{ github.event.inputs.version_tag }}" ]; then
          VERSION="${{ github.event.inputs.version_tag }}"
        else
          VERSION="v$(date +'%Y.%m.%d')-$(echo ${{ github.sha }} | cut -c1-7)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "timestamp=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        
        # Configurar ambiente
        ENV="${{ github.event.inputs.environment || 'production' }}"
        echo "environment=$ENV" >> $GITHUB_OUTPUT
        
        echo "ğŸš€ Deploy iniciado - VersÃ£o: $VERSION | Ambiente: $ENV"

    - name: Testar conectividade SSH (se debug ativado)
      if: github.event.inputs.debug_ssh == 'true'
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        debug: true
        script: |
          echo "ğŸ” Teste de conectividade SSH..."
          echo "UsuÃ¡rio: $(whoami)"
          echo "DiretÃ³rio: $(pwd)"
          echo "Sistema: $(uname -a)"
          echo "Data: $(date)"
          echo "âœ… SSH funcionando corretamente!"
      
    - name: Deploy para VPS
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        timeout: 300s
        command_timeout: 60m
        script: |
          set -e  # Parar em qualquer erro
          
          DOMAIN="${{ secrets.DOMAIN_NAME }}"
          VERSION="${{ steps.vars.outputs.version }}"
          ENVIRONMENT="${{ steps.vars.outputs.environment }}"
          FORCE_SSL="${{ github.event.inputs.force_ssl_setup || 'false' }}"
          
          echo "ğŸš€ Iniciando deploy $VERSION para $DOMAIN (ambiente: $ENVIRONMENT)..."
          
          # Configurar diretÃ³rios
          mkdir -p ~/carangode ~/logs
          cd ~/carangode
          
          # Configurar repositÃ³rio
          if [ ! -d ".git" ]; then
            git init
            git remote add origin ${{ github.server_url }}/${{ github.repository }}.git
          fi
          
          git fetch origin main
          git reset --hard origin/main
          
          # Criar arquivo de versÃ£o
          echo "$VERSION" > VERSION
          echo "Deploy realizado em: ${{ steps.vars.outputs.timestamp }}" >> VERSION
          echo "Commit: ${{ github.sha }}" >> VERSION
          echo "Ambiente: $ENVIRONMENT" >> VERSION
          
          # Dar permissÃµes aos scripts
          chmod +x *.sh
          
          # Instalar Node.js 20 LTS (requerido pelo React Router 7)
          if ! node --version | grep -q "v20"; then
            echo "ğŸ“¦ Instalando Node.js 20 LTS..."
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          
          # Instalar PM2 e serve
          if ! command -v pm2 &> /dev/null; then
            sudo npm install -g pm2@latest
          fi
          if ! command -v serve &> /dev/null; then
            sudo npm install -g serve@latest
          fi
          
          echo "ğŸ”§ Configurando backend..."
          cd backend
          
          # Criar .env do backend
          cat > .env << EOF
          DATABASE_URL="${{ secrets.DATABASE_URL }}"
          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          ADMIN_USERNAME="${{ secrets.ADMIN_USERNAME }}"
          ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}"
          PORT=5000
          NODE_ENV=$ENVIRONMENT
          FRONTEND_URL=https://$DOMAIN
          VERSION=$VERSION
          EOF
          
          # Instalar dependÃªncias e configurar banco
          npm ci --production --silent
          npx prisma generate
          npx prisma migrate deploy
          
          # Restart backend
          pm2 stop backend 2>/dev/null || true
          pm2 delete backend 2>/dev/null || true
          pm2 start src/server.js --name "backend" --max-memory-restart 150M
          
          echo "âš›ï¸ Configurando frontend..."
          cd ../frontend
          
          # Criar .env do frontend
          cat > .env << EOF
          VITE_API_URL=https://$DOMAIN/api
          NODE_ENV=$ENVIRONMENT
          VITE_VERSION=$VERSION
          EOF
          
          # Build e start frontend
          npm ci --silent
          npm run build
          
          pm2 stop frontend 2>/dev/null || true
          pm2 delete frontend 2>/dev/null || true
          pm2 start "npx serve -s build/client -l 3000" --name "frontend" --max-memory-restart 100M --cwd ~/carangode/frontend
          
          echo "ğŸŒ Configurando Nginx e SSL..."
          cd ..
          
          # Configurar SSL baseado na flag force_ssl_setup
          if [ "$FORCE_SSL" = "true" ] || [ ! -f "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" ]; then
            echo "ğŸ”’ Executando configuraÃ§Ã£o SSL..."
            if sudo ./setup-ssl.sh "$DOMAIN"; then
              echo "âœ… SSL configurado com sucesso!"
            else
              echo "âš ï¸ SSL falhou, configurando nginx apenas com HTTP..."
              # Fallback: configurar nginx sem SSL
              sed -i "s/DOMAIN_PLACEHOLDER/$DOMAIN/g" nginx.conf
              
              # Criar versÃ£o HTTP-only do nginx.conf
              sed -e '/listen 443 ssl/d' \
                  -e '/ssl_certificate/d' \
                  -e '/include .*letsencrypt/d' \
                  -e '/ssl_dhparam/d' \
                  -e 's/listen 80;/listen 80 default_server;/' \
                  -e '/return 301 https/d' \
                  nginx.conf > /tmp/nginx-http.conf
              
              sudo cp /tmp/nginx-http.conf /etc/nginx/sites-available/carangode
              sudo ln -sf /etc/nginx/sites-available/carangode /etc/nginx/sites-enabled/
              sudo rm -f /etc/nginx/sites-enabled/default
              
              if sudo nginx -t && sudo systemctl restart nginx; then
                echo "âœ… Nginx HTTP configurado com sucesso"
              else
                echo "âŒ Falha crÃ­tica na configuraÃ§Ã£o nginx"
                sudo nginx -t || true
                exit 1
              fi
            fi
          else
            echo "âœ… SSL jÃ¡ configurado, aplicando configuraÃ§Ã£o nginx..."
            # Apenas configurar nginx se SSL jÃ¡ existe
            sed -i "s/DOMAIN_PLACEHOLDER/$DOMAIN/g" nginx.conf
            sudo cp nginx.conf /etc/nginx/sites-available/carangode
            sudo ln -sf /etc/nginx/sites-available/carangode /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t && sudo systemctl reload nginx
          fi
          
          # Configurar PM2 para iniciar com sistema
          pm2 save
          sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u ${{ secrets.VPS_USERNAME }} --hp /home/${{ secrets.VPS_USERNAME }} 2>/dev/null || true
          
          # Aguardar serviÃ§os estabilizarem
          sleep 5
          
          echo ""
          echo "ğŸ” VerificaÃ§Ãµes de saÃºde..."
          
          # Teste das rotas CORRETAS
          if curl -sf http://localhost:5000/api/cursos > /dev/null; then
            echo "âœ… Backend (API) funcionando"
          else
            echo "âŒ Backend nÃ£o responde"
            pm2 logs backend --lines 5 --nostream
          fi
          
          if curl -sf http://localhost:3000 > /dev/null; then
            echo "âœ… Frontend funcionando"
          else
            echo "âŒ Frontend nÃ£o responde"
            pm2 logs frontend --lines 5 --nostream
          fi
          
          if sudo systemctl is-active --quiet nginx; then
            echo "âœ… Nginx ativo"
          else
            echo "âŒ Nginx inativo"
            sudo systemctl status nginx --no-pager -l
          fi
          
          # SSL check
          if [ -f "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" ]; then
            echo "âœ… SSL configurado e renovaÃ§Ã£o automÃ¡tica ativada"
            PROTOCOL="https"
          else
            echo "âš ï¸ Usando HTTP (sem SSL)"
            PROTOCOL="http"
          fi
          
          echo ""
          echo "ğŸ‰ Deploy $VERSION concluÃ­do com sucesso!"
          echo "ğŸŒ Site: $PROTOCOL://$DOMAIN"
          echo "ğŸ”§ API: $PROTOCOL://$DOMAIN/api/cursos"
          echo "ğŸ“¦ VersÃ£o: $VERSION"
          echo "ğŸŒ Ambiente: $ENVIRONMENT"
          echo ""
          echo "ğŸ“Š Status dos serviÃ§os:"
          pm2 status
          echo ""
          echo "ğŸ”’ Certificados SSL:"
          sudo certbot certificates 2>/dev/null || echo "Certbot nÃ£o configurado"

    - name: Criar Release AutomÃ¡tico
      if: success() && github.event_name == 'push'  # SÃ³ para push automÃ¡tico
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.vars.outputs.version }}
        release_name: 'Release ${{ steps.vars.outputs.version }}'
        body: |
          ğŸš€ **Deploy AutomÃ¡tico - ${{ steps.vars.outputs.version }}**
          
          **ğŸ“… Data:** ${{ steps.vars.outputs.timestamp }}
          **ğŸ”§ Commit:** ${{ github.sha }}
          **ğŸŒ Ambiente:** ${{ steps.vars.outputs.environment }}
          **ğŸ‘¤ Autor:** ${{ github.actor }}
          
          **ğŸ“‹ AlteraÃ§Ãµes incluÃ­das:**
          ${{ github.event.head_commit.message }}
          
          **ğŸ”— Links:**
          - ğŸŒ [Site ao vivo](https://${{ secrets.DOMAIN_NAME }})
          - ğŸ”§ [API](https://${{ secrets.DOMAIN_NAME }}/api/cursos)
          
          ---
          *Release criado automaticamente pelo GitHub Actions*
        draft: false
        prerelease: false

    - name: Comentar no commit (se manual)
      if: success() && github.event_name == 'workflow_dispatch'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `ğŸš€ **Deploy Manual Realizado**
            
            **ğŸ“¦ VersÃ£o:** ${{ steps.vars.outputs.version }}
            **ğŸŒ Ambiente:** ${{ steps.vars.outputs.environment }}
            **ğŸ‘¤ Executado por:** @${{ github.actor }}
            **ğŸ“… Data:** ${{ steps.vars.outputs.timestamp }}
            
            **ğŸ”— Links:**
            - ğŸŒ [Site ao vivo](https://${{ secrets.DOMAIN_NAME }})
            - ğŸ”§ [API](https://${{ secrets.DOMAIN_NAME }}/api/cursos)
            
            âœ… Deploy concluÃ­do com sucesso!`
          })

    - name: Notificar status
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Deploy realizado com sucesso!"
          echo "ğŸŒ Site: https://${{ secrets.DOMAIN_NAME }}"
          echo "ğŸ“¦ VersÃ£o: ${{ steps.vars.outputs.version }}"
        else
          echo "âŒ Deploy falhou!"
          echo "ğŸ” Verifique os logs acima para detalhes"
          echo ""
          echo "ğŸ’¡ Dicas para resolver problemas SSH:"
          echo "  1. Verifique se VPS_HOST, VPS_USERNAME estÃ£o corretos"
          echo "  2. Configure VPS_SSH_KEY (preferÃ­vel) ou VPS_PASSWORD"
          echo "  3. Execute com 'Debug SSH' = true para mais informaÃ§Ãµes"
        fi 